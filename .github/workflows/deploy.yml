name: Deploy

on:
  workflow_run:
    workflows: ["Build and Push"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: docker.io
  IMAGE_NAME: sarafrika-camp-ussd

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Server
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install sshpass
      run: sudo apt-get update && sudo apt-get install -y sshpass
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: Create deployment directory
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ~/products/camp-ussd"
        
    - name: Copy deployment files
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' scp docker-compose.yml .env.example ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:~/products/camp-ussd/
        
    - name: Setup environment configuration
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/products/camp-ussd
          
          # Create .env file from template if it doesn't exist
          if [ ! -f .env ]; then
            echo "ðŸ“‹ Creating .env file from .env.example template..."
            cp .env.example .env
            echo "âš ï¸  .env file created from template. Please configure the following required variables:"
          else
            echo "ðŸ“‹ .env file already exists. Validating configuration..."
          fi
        EOF
        
    - name: Validate environment configuration
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/products/camp-ussd
          
          # Define required environment variables
          required_vars=(
            "DATABASE_URL"
            "DATABASE_USERNAME" 
            "DATABASE_PASSWORD"
            "AFRICAS_TALKING_USERNAME"
            "AFRICAS_TALKING_API_KEY"
            "AFRICAS_TALKING_USSD_SERVICE_CODE"
            "MPESA_CONSUMER_KEY"
            "MPESA_CONSUMER_SECRET"
            "MPESA_SHORTCODE"
            "MPESA_PASSKEY"
          )
          
          missing_vars=()
          placeholder_vars=()
          
          # Check each required variable
          for var in "${required_vars[@]}"; do
            if ! grep -q "^${var}=" .env; then
              missing_vars+=("$var")
            else
              value=$(grep "^${var}=" .env | cut -d'=' -f2-)
              # Check if value contains placeholder text or is empty
              if [[ -z "$value" ]] || [[ "$value" =~ ^(your_|your-) ]]; then
                placeholder_vars+=("$var")
              fi
            fi
          done
          
          # Report missing variables
          if [ ${#missing_vars[@]} -gt 0 ]; then
            echo "âŒ Missing required environment variables:"
            printf "   - %s\n" "${missing_vars[@]}"
          fi
          
          # Report placeholder values
          if [ ${#placeholder_vars[@]} -gt 0 ]; then
            echo "âš ï¸  Environment variables with placeholder values (need configuration):"
            printf "   - %s\n" "${placeholder_vars[@]}"
          fi
          
          # Fail if there are missing or unconfigured variables
          if [ ${#missing_vars[@]} -gt 0 ] || [ ${#placeholder_vars[@]} -gt 0 ]; then
            echo ""
            echo "ðŸ’¡ Please update the .env file on the server at: ~/products/camp-ussd/.env"
            echo "   Use the .env.example as a reference for required configuration."
            exit 1
          else
            echo "âœ… All required environment variables are properly configured"
          fi
        EOF
        
    - name: Deploy application
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/products/camp-ussd
          
          # Pull latest image
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Stop existing containers
          docker-compose down || true
          
          # Start services
          docker-compose up -d
          
          # Clean up old images
          docker image prune -f
        EOF
        
    - name: Verify deployment
      run: |
        # Wait a moment for the service to be fully ready
        sleep 30
        
        # Check if the application is responding on the remote server
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:40000/q/health/live || echo "000")
          
          if [ "$response" -eq 200 ]; then
            echo "âœ… Deployment successful - Application is healthy"
          else
            echo "âŒ Deployment failed - Application is not responding (HTTP $response)"
            exit 1
          fi
        EOF
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸš€ Deployment to ${{ github.event.inputs.environment || 'production' }} completed successfully!"
        else
          echo "ðŸ’¥ Deployment to ${{ github.event.inputs.environment || 'production' }} failed!"
        fi