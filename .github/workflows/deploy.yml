name: Deploy

on:
  workflow_run:
    workflows: ["Build and Push"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: docker.io
  IMAGE_NAME: sarafrika-camp-ussd

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Server
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install sshpass
      run: sudo apt-get update && sudo apt-get install -y sshpass
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: Create deployment directory
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ~/products/camp-ussd"
        
    - name: Copy deployment files
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' scp docker-compose.yml ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:~/products/camp-ussd/
        
    - name: Create or update .env file
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/products/camp-ussd
          
          # Create .env file if it doesn't exist, or update DOCKERHUB_USERNAME
          if [ ! -f .env ]; then
            cp .env.example .env 2>/dev/null || echo "# Environment variables" > .env
          fi
          
          # Update or add DOCKERHUB_USERNAME
          if grep -q "^DOCKERHUB_USERNAME=" .env; then
            sed -i "s/^DOCKERHUB_USERNAME=.*/DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}/" .env
          else
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env
          fi
        EOF
        
    - name: Deploy application
      run: |
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/products/camp-ussd
          
          # Pull latest image
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Stop existing containers
          docker-compose down || true
          
          # Start services
          docker-compose up -d
          
          # Clean up old images
          docker image prune -f
        EOF
        
    - name: Verify deployment
      run: |
        # Wait a moment for the service to be fully ready
        sleep 30
        
        # Check if the application is responding on the remote server
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:40000/q/health/live || echo "000")
          
          if [ "$response" -eq 200 ]; then
            echo "âœ… Deployment successful - Application is healthy"
          else
            echo "âŒ Deployment failed - Application is not responding (HTTP $response)"
            exit 1
          fi
        EOF
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸš€ Deployment to ${{ github.event.inputs.environment || 'production' }} completed successfully!"
        else
          echo "ðŸ’¥ Deployment to ${{ github.event.inputs.environment || 'production' }} failed!"
        fi